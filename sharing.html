<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "/usr/share/4Suite/Schemata/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><link rel="alternate" type="application/rss+xml" title="Thomas Leonard's blog" href="http://rox.sourceforge.net/desktop/blog/1/feed" /><link rel="stylesheet" type="text/css" href="style.css" /><title>The Zero Install system</title></head><body><h1>The Zero Install system</h1><table><tr><td class="sidebar"><h2>Navigation</h2><ul class="pages"><li class="open"><a href="index.html">Overview 
      </a><ul><li class="leaf"><a href="injector.html">Install 
      </a></li><li class="leaf"><a href="injector-using.html">Tutorial 
      </a></li><li class="leaf"><a href="injector-feeds.html">Software index 
      </a></li><li class="leaf"><a href="injector-trouble.html">Problems 
      </a></li></ul></li><li class="open"><a href="doc.html">Documentation 
      </a><ul><li class="leaf"><a href="goals.html">Goals 
      </a></li><li class="leaf"><a href="howitworks.html">Screenshots 
      </a></li><li class="leaf"><a href="perspectives.html">Perspectives 
      </a></li><li class="leaf"><a href="flash.html">Flash demos 
      </a></li><li class="leaf"><a href="matrix.html">Comparison 
      </a></li><li class="leaf"><a href="faq.html">FAQ 
      </a></li><li class="leaf"><a href="injector-security.html">Security 
      </a></li><li class="leaf"><a href="sharing.html" class="selected">Sharing 
      </a></li><li class="leaf"><a href="walkthrough.html">Walk-through 
      </a></li><li class="leaf"><a href="distribution-integration.html">Distro integration 
      </a></li><li class="leaf"><a href="roadmap.html">Roadmap 
      </a></li><li class="leaf"><a href="links.html">Links 
      </a></li></ul></li><li class="open"><a href="dev.html">Developers 
      </a><ul><li class="closed"><a href="injector-packagers.html">Packaging guide 
      </a></li><li class="closed"><a href="injector-specs.html">Specifications 
      </a></li><li class="leaf"><a href="0publish.html">0publish 
      </a></li><li class="closed"><a href="0compile.html">0compile 
      </a></li><li class="leaf"><a href="feedlint.html">FeedLint 
      </a></li><li class="leaf"><a href="python-api/html/index.html">Python API 
      </a></li><li class="leaf"><a href="injector-design.html">Design 
      </a></li><li class="leaf"><a href="injector-tests.html">Tests 
      </a></li></ul></li><li class="leaf"><a href="support.html">Support 
      </a></li><li class="open"><a href="filesystem.html">Old stuff 
      </a><ul><li class="closed"><a href="filesystem.html">Filesystem 
      </a></li></ul></li></ul><form id="searchbox_010445122533180311286:4ee7gv0f1pc" action="http://google.com/cse"><p><input type="hidden" name="cx" value="010445122533180311286:4ee7gv0f1pc" /><input name="q" type="text" size="18" /><input type="submit" name="sa" value="Search" /><input type="hidden" name="cof" value="FORID:0" /></p></form><h2>SourceForge</h2><ul><li class="leaf"><a href="http://sourceforge.net/projects/zero-install">Project page</a></li><li class="leaf"><a href="http://sourceforge.net/svn/?group_id=76468">Subversion access</a></li><li class="leaf"><a href="http://sourceforge.net/project/showfiles.php?group_id=76468">File releases</a></li><li class="leaf"><a href="http://sourceforge.net/project/stats/detail.php?group_id=76468&amp;ugn=zero-install&amp;type=prweb&amp;mode=alltime">Statistics</a></li></ul></td><td class="main"><p class="author">Dr Thomas Leonard [ <a href="support.html">contact</a> | <a href="public_key.gpg">GPG public key</a> | <a href="http://rox.sourceforge.net/desktop/blog/1">blog</a> | <a href="http://sourceforge.net/developer/user_donations.php?user_id=40461">donations</a> ]</p><div class="main">

<h2 id="id2244845">Sharing downloads between users</h2>

 <p>
   On systems with multiple users, it would be very inefficient if each user had to download their own copy
   of each program. Most packaging systems require users to have root access in order to share software
   (either the root password, or admin access through sudo). However, this is a security risk. Zero Install
   allows software to be shared automatically and safely between mutually-untrusting users.
 </p>

 <ol><li><a href="#id2242557">How it works</a></li><li><a href="#id2245740">Setting up sharing for version 0.30 or later</a></li><li><a href="#id2245863">Setting up sharing for older versions (before 0.30)</a></li><li><a href="#id2245986">Questions</a></li></ol>

 <h3 id="id2242557">How it works</h3>

 <p>
  A digest is a short value calculated from a (usually much bigger) file. There
  are various different algorithms that can be used. For example, this command
  calculates the SHA1 digest of the <b>ls</b> binary:
 </p>

 <pre>
$ <b>sha1sum /bin/ls</b>
90b703d3d29ef20f3ef711eb38625d618c70c4f6  /bin/ls
 </pre>

 <p>
  A <i>cryptographic</i> digest (like SHA1) is one where it is believed to be
  infeasibly difficult to create a different program with the same digest. So,
  if someone gives you a binary with digest above, you can be sure that it's
  identical to the version of <b>ls</b> that I'm using.
 </p>

 <p>
  Cryptographic digests are the basis of secure sharing in Zero Install. Here's we'll see an example of how two users (Alice and Bob)
  can share the ROX-Filer program, even if they don't trust each other.
 </p>

 <p class="diagram">
   <img src="sharing.png" width="400" height="268" alt="How sharing works in Zero Install" />
 </p>

 <p>
  First, Alice runs ROX-Filer:
 </p>

 <ol>
  <li>Alice visits <a href="http://rox.sourceforge.net">rox.sourceforge.net</a> and downloads
  the small <a href="http://rox.sourceforge.net/2005/interfaces/ROX-Filer">ROX-Filer.xml</a> feed file.</li>
  <li>She decides to run ROX-Filer version 2.5 from this file.</li>
  <li>The Zero Install software gets the digest for this version (<b>sha1=d22a35871bad157e32aa169e3f4feaa8d902fdf2</b>) from
  the file. It also downloads the package and unpacks it.</li>
  <li>The software passes the unpacked archive to the privileged helper, which checks the digest and copies the directory
  to <b>/var/cache/0install.net/implementations/sha1=d22a35871bad157e32aa169e3f4feaa8d902fdf2</b>.</li>
  <li>ROX-Filer runs.</li>
 </ol>

 <p>
  Later, Bob decides to run it too. The system doesn't need to download a second copy:
 </p>

 <ol>
  <li>Bob visits <a href="http://rox.sourceforge.net">rox.sourceforge.net</a> and downloads
  the small <a href="http://rox.sourceforge.net/2005/interfaces/ROX-Filer">ROX-Filer.xml</a> feed file.</li>
  <li>He decides to run ROX-Filer version 2.5 from this file.</li>
  <li>The Zero Install software gets the digest for this version (<b>sha1=d22a35871bad157e32aa169e3f4feaa8d902fdf2</b>) from
  the file.</li>
  <li>Zero Install sees that the directory <b>/var/cache/0install.net/implementations/sha1=d22a35871bad157e32aa169e3f4feaa8d902fdf2</b>
  already exists, so it doesn't download the software again.</li>
  <li>ROX-Filer runs.</li>
 </ol>

 <p>
  But what if we have a malicious user, Charlie? A new machine arrives, and Charlie decides to install a malicious version
  of ROX-Filer before anyone else installs a good copy:
 </p>

 <ol>
  <li>Charlie visits <a href="http://rox.sourceforge.net">rox.sourceforge.net</a> and downloads
  the small <a href="http://rox.sourceforge.net/2005/interfaces/ROX-Filer">ROX-Filer.xml</a> feed file.</li>
  <li>He decides to use ROX-Filer version 2.5 from this file.</li>
  <li>The Zero Install software gets the digest for this version (<b>sha1=d22a35871bad157e32aa169e3f4feaa8d902fdf2</b>) from
  the file. It also downloads the package and unpacks it.</li>
  <li>Charlie modifies the download to do something nasty (or, the download has been tampered with, or Charlie's account
  has been infected with a virus which modifies it, etc).</li>
  <li>If Charlie tries to install the result
  to <b>/var/cache/0install.net/implementations/sha1=d22a35871bad157e32aa169e3f4feaa8d902fdf2</b>, the privileged helper
  rejects it, because the digest of the directory's contents no longer matches that name.</li>
  <li>Charlie is forced to install his malicious version as <b>/var/cache/0install.net/implementations/sha1=3ab21d8f410e3a5a863d3a32a152edb31ba42f75</b> instead.</li>
 </ol>

 <p>
  When Alice runs ROX-Filer as before, the software sees that <b>/var/cache/0install.net/implementations/sha1=d22a35871bad157e32aa169e3f4feaa8d902fdf2</b> doesn't
  exist and downloads a genuine copy as before. When Bob runs ROX-Filer, he will use Alice's version.
 </p>

 <p class="diagram">
   <img src="sharing-evil.png" width="549" height="268" alt="Charlie adds a modified copy to the system" />
 </p>

 <p>
  You might be worried that Charlie was able to put malicious code in the shared cache. However, it doesn't matter because other users won't try to run it, since
  it doesn't have the name they're looking for. Of course, it might not even be malicious: a program that deletes files is malicious if it's called <b>cat</b>, but
  not if it's called <b>rm</b>. As long as users don't go around running random binaries they find in the cache, they're OK.
 </p>

 <h3 id="id2245740">Setting up sharing for version 0.30 or later</h3>

 <p>
  These instructions are for version 0.30. See below if you have an older version (<b>0launch --version</b> will display the current version).
 </p>

 <p>
  The actual code for doing sharing this way is currently <b>EXPERIMENTAL</b> and not enabled by default. This section shows how the system administrator (someone with
  root access) can enable it. <b>DO NOT</b> do this in security critical environments yet - we're still working on tightening the security on this! Feedback welcome.
 </p>

 <ol>
  <li><a href="injector.html">Install 0launch version 0.30</a> or later.</li>
  <li>Create a new system user called 'zeroinst' (the Ubuntu package will have done this for you automatically).
<pre>
# adduser --system zeroinst
</pre>
</li>
  <li>Create the shared directory, owned by this new user (also done automatically by the Ubuntu package):
<pre>
# mkdir /var/cache/0install.net
# chown zeroinst /var/cache/0install.net
</pre>
</li>

  <li>Create <b>/usr/local/bin/0store-secure-add-helper</b> with:
  <pre>
#!/bin/sh
exec sudo -S -u zeroinst /usr/bin/0store-secure-add "$@" &lt; /dev/null
</pre>
</li>

  <li>Make your new script executable:
<pre>
# chmod a+x /usr/local/bin/0store-secure-add-helper
</pre></li>

  <li>Use <b>visudo</b> to add these lines to <b>/etc/sudoers</b>:
<pre>
Defaults&gt;zeroinst env_reset
ALL ALL=(zeroinst) NOPASSWD: /usr/bin/0store-secure-add
</pre>
 <p><strong>Note:</strong> the NOPASSWD line MUST go at the end of the file, otherwise it is likely to be overridden by
 later entries.</p>
</li>
 </ol>

 <p>
  When 0launch wants to install a package, it will invoke <b>0store-secure-add-helper</b>. This
  script uses <b>sudo</b> to run <b>0store-secure-add</b> as the <b>zeroinst</b> user, with
  a clean environment. No password is required for this.
 </p>

 <h3 id="id2245863">Setting up sharing for older versions (before 0.30)</h3>

 <p>
  The actual code for doing sharing this way is currently <b>EXPERIMENTAL</b> and not enabled by default. This section shows how the system administrator (someone with
  root access) can enable it. <b>DO NOT</b> do this in security critical environments yet - we're still working on tightening the security on this! Feedback welcome.
 </p>

 <ol>
  <li><a href="injector.html">Install 0launch version 0.26</a> or later.</li>
  <li>Create a new system user called 'zeroinst' (this command is for Debian; other systems may need other commands):
<pre>
# adduser --system zeroinst
</pre>
</li>
  <li>Create the shared directory, owned by this new user:
<pre>
# mkdir /var/cache/0install.net
# chown zeroinst /var/cache/0install.net
</pre>
</li>

  <li>Create <b>/usr/local/bin/0store-helper</b> with:
  <pre>
#!/bin/sh
cd "$2" || exit 1
chmod -R a+rX .
exec sudo -u zeroinst /usr/local/bin/0store-helper-priv "$1"
</pre>
</li>

  <li>Create <b>/usr/local/bin/0store-helper-priv</b> with:
<pre>
#!/bin/sh
exec 0store add "$1" .
</pre>
  </li>

  <li>Make your new scripts executable:
<pre>
# chmod a+x /usr/local/bin/0store-helper
# chmod a+x /usr/local/bin/0store-helper-priv
</pre></li>

  <li>Use <b>visudo</b> to add these lines to <b>/etc/sudoers</b>:
<pre>
Cmnd_Alias      ZEROINSTALL = /usr/local/bin/0store-helper-priv
Defaults&gt;zeroinst env_reset
ALL     ALL=(zeroinst) NOPASSWD: ZEROINSTALL
</pre>
 <p><strong>Note:</strong> the NOPASSWD line MUST go at the end of the file, otherwise it is likely to be overridden by
 later entries.</p>
</li>
 </ol>

 <p>
  When 0launch wants to install a package, it will invoke <b>0store-helper</b>. This
  script uses <b>sudo</b> to run <b>0store-helper-priv</b> as the <b>zeroinst</b> user, with
  a clean environment. No password is required for this.
 </p>

 <h3 id="id2245986">Questions</h3>

 <dl>
  <dt>How do users uninstall?</dt>
  <dd>Currently, they can't. You (the admin) can delete directories from <b>/var/cache/0install.net/implementations</b>
  to save space (preferably not while they're being used ;-). Ideally, we should track which users have requested which
  programs and remove them automatically when no-one wants them anymore.</dd>

  <dt>What kind of things need 'tightening'?</dt>
  <dd>Several things spring to mind:
   <ul>
    <li>What happens if the user changes the directory whilst it's being added? We need to audit 0store-secure-add.</li>
    <li>Denial of service attacks, if one user stores lots of stuff (need quotas).</li>
   </ul>
  </dd>

  <dt>Why do things still get stored in <b>~/.cache</b> after setting this up?</dt>
  <dd>
    Things you've already installed will remain there. Only new software is added in the system cache.
    Also, the old <b>sha1</b> algorithm isn't accepted by the helper, so software using that can't
    go in the shared cache. If you still have problems, try running <b>0launch -vvc URI</b> (to see debug output).
    Finally, make sure your script is executable!
  </dd>
  </dl>

</div><div class="footer"><p>
	   Thanks to the University of Southampton for the 0install.org, 0install.net,
	   zero-install.org and zero-install.net domain names!
	 </p><p>
	    Web-site © Copyright 2003-2007, Thomas Leonard.<br />
	    Permission is granted to use the site (excluding the software,
	    which is licensed separately)<br />in accordance with the terms of the
	    <a href="http://creativecommons.org/licenses/by-sa/2.5/">Creative
	    Commons Attribution-ShareAlike 2.5 license</a>.<br />
	    Some of the icons are from (or based on icons from) the
	    <a href="http://tango-project.org/Tango_Desktop_Project">Tango Desktop Project</a>.
	  </p><p><a href="http://creativecommons.org/licenses/by-sa/2.5/"><img src="http://creativecommons.org/images/public/somerights20.gif" alt="Attribution-ShareAlike" width="88" height="31" /></a></p><div class="logos"><a href="http://sourceforge.net/projects/zero-install"><img width="88" height="31" alt="SF logo" src="http://sourceforge.net/sflogo.php?group_id=7023&amp;type=1" /></a><a href="http://jigsaw.w3.org/css-validator/check/referer"><img style="border:0;width:88px;height:31px" src="http://jigsaw.w3.org/css-validator/images/vcss" alt="Valid CSS!" /></a><a class="outside" href="http://validator.w3.org/check/referer"><img src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0!" height="31" width="88" /></a></div></div></td></tr></table></body></html>
